@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>主页顶部广告设置 </h1>

<div style="width: 900px;">
    <div class="mini-toolbar" style="border-bottom: 0; padding: 0px;">
        <a class="mini-button" iconcls="icon-add " onclick="add()">增加</a>
        <a class="mini-button" iconcls="icon-edit" onclick="edit()">编辑</a>
        <a class="mini-button" iconcls="icon-remove" onclick="remove()">删除</a>
    </div>
</div>
<div id="searchGridPanel" class="mini-panel" title="header" iconcls="icon-add" style="width: 800px; height: 450px; position: absolute; z-index: 888;"
    showtoolbar="true" showclosebutton="true" showheader="false" bodystyle="padding:0" borderstyle="border:0">
    <div property="toolbar" style="padding: 5px; padding-left: 8px; text-align: center;">
        <span>分类:</span><input id="category" class="mini-combobox" style="width: 150px;" textfield="Name" valuefield="Id"
            url="../../category/list" value="" required="true" allowinput="false" />
        <span>线路名：</span>
        <input id="nameText" class="mini-textbox" style="width: 160px;" onenter="onSearchClick" />
        <a class="mini-button" iconcls="icon-search" onclick="onSearchClick">查询</a>
        <a class="mini-button" iconcls="icon-close" onclick="onCloseClick">关闭</a>
        <a class="mini-button" iconcls="icon-ok " onclick="onDoneClick">完成</a>
    </div>
    <div id="searchGrid" class="mini-datagrid" style="width: 100%; height: 100%;"
        borderstyle="border:0" showpagesize="true" showpageindex="true" multiselect="true"
        url="../../lineapi/?state=5">
        <div property="columns">
            <div type="checkcolumn">#</div>
            <div field="Id" width="120" headeralign="center" renderer="onImageRenderer">图像</div>
            <div field="Name" width="120" headeralign="center">线路名</div>
            <div field="CreateTime" width="100" headeralign="center">创建日期</div>


        </div>
    </div>


</div>
<div id="postgrid" class="mini-datagrid" style="width: 900px; height: 500px;"
    borderstyle="border:0" showpagesize="false" showpageindex="false"
    url="../../lineapi/?state=1">
    <div property="columns">
        <div type="indexcolumn" width="15"></div>
        <div field="Image" width="180" headeralign="center" renderer="onImageRenderer">图像</div>
        <div field="Name" width="80" headeralign="center">广告标题</div>
        <div field="CreateTime" width="80px" headeralign="center" dateformat="yyyy-MM-dd">创建日期</div>
        <div field="Action" width="120px" headeralign="center" renderer="onActionRenderer">操作</div>
    </div>
</div>
<div id="editWindow" class="mini-window" title="设置头部滚动广告" style="width: 850px; height:500px;"
    showmodal="true" allowresize="true" allowdrag="true">
    <div id="editform" class="form">
        <input class="mini-hidden" name="Id" id="postId" />
        <table>
            <tr>
                <td>
                    <label>线路名：</label>
                </td>
                <td>
                    <input type="text" style="width: 300px;" readonly="readonly" id="postname" />
                </td>
            </tr>
            <tr>
                <td>
                    <label for="title$text">广告标题：</label>
                </td>
                <td>
                    <input id="title" name="title" width="300px" class="mini-textbox" required="true" />
                </td>
            </tr>
            <tr>
                <td>序号：
                </td>
                <td>
                    <input name="postOrder" id="order" class="mini-spinner" value="0" minvalue="1" maxvalue="50" width="50px" />
                </td>
            </tr>
            <tr>
                <td>图片：
                </td>
                <td>
                    <select name="imageId" id="image" class="egg_imagedropdown" imageId=""></select> 
                </td>
                <td><span id="upLoadButton"></span></td>
            </tr>
            <tr>
                <td><a class="mini-button" id="submit" iconCls="icon-save">保存</a></td>
                <td><a class="mini-button" id="close" iconCls="icon-remove">取消</a></td>
            </tr>
        </table>
    </div>
</div>
<div id="cropWindow" class="mini-window" title="剪裁图片" style="width:590px; height:460px;" 
    showModal="true" allowResize="true" allowDrag="true"
    >
  <div class="crop"> 
   <div id="cropzoom_container" ></div> 
   <div class="page_btn" style="margin:0 auto;"> 
       <a class="mini-button" id="crop" iconCls="icon-save">剪切照片</a>
        <a class="mini-button" id="restore" iconCls="icon-reload"> 照片复位</a>
    
   </div> 
   <div class="clear"></div> 
</div>
</div>
<script type="text/javascript">
    imageType = 3;
    mini.parse();
    var postgrid = mini.get("postgrid");
    var gridPanel = mini.get("searchGridPanel");
    var searchGrid = mini.get("searchGrid");

    gridPanel.hide();
    postgrid.load();
    function onImageRenderer(e) {
        var grid = e.sender;
        var record = e.record;
        var img = record.Image;
        var rowIndex = e.rowIndex;
        var s = '<img src="' + img + '"><br/><label style="margin:0 auto;">' + record.Name + '</label>';
        return s;
    }
    function onActionRenderer(e) {
        var grid = e.sender;
        var record = e.record;
        var img = record.Image;
        var rowIndex = e.rowIndex;
        var s = '<a class="mini-button mini-grid-button"   onclick="lineOp(\'' + e.record.Id + '\',\'unpost\')">取消</a><a class="mini-button mini-grid-button"   onclick="lineOp(\'' + e.record.Id + '\',\'close\')">取消并隐藏</a><br/>';
        return s;
    }
    function onSearchClick(e) {
        searchGrid.load({
            category: mini.get("category").value,
            name: mini.get("nameText").value
        });
    }
    function edit() {
        var swf;
        try { swf = swfuploadInit(); } catch (e) { }

        var row = postgrid.getSelected();
        var editWindow = mini.get("editWindow");
        $("#postId").val(row.Id);
        $("#postname").val(row.Name);
        $("#postImg").attr("src", row.Image);

        editWindow.show();
        $("#image").attr("imageId", row.image);
        swfu = new SWFUpload(swfSetting);
        loadingImg("image", "", 3);
    }



    function lineOp(id, op) {

        $.post("../../line/op/" + id + "/" + op, {}, function (data) { alert(data); postgrid.load({ state: $("#tabs li.current").attr("type") }); });

    }
    function onCloseClick(e) {
        gridPanel.hide();
    }
    function add() {
        searchGrid.load();
        gridPanel.show();
      
    }
    function onDoneClick() {
        var rows = searchGrid.getSelecteds();
        if (rows.length <= 0) {
            mini.alert("尚未选择一条项目！");
            return;
        }
        if (rows.length + postgrid.totalCount > 15) {
            mini.alert("顶部项目请不要超过15条,现在已经展示了" + postgrid.totalCount + "条");
            return;
        }
        var s = "{";
        for (i = 0; i < rows.length; i++) {
            s += "\"id[" + i + "]\":\"" + rows[i].Id + "\",";
        }
        s = s.substr(0, s.length - 1);
        s += "}"

        $.post("../../post/add", JSON.parse(s), function (data) { postgrid.load(); });
        gridPanel.hide();
    }


    $("#submit").click(function () {

        $.post("../../post/edit", { "id": $("#postId").val(), "title": mini.get("title").getValue(),imageId:$("#image").val(),order:mini.get("order").getValue() }, function () { });
    });
    $("#close").click(function () {
        editWindow.hide();
    });
</script>



